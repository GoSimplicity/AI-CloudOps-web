<template>
  <div class="k8s-management-container">
    <!-- È°µÈù¢Â§¥ÈÉ® -->
    <div class="k8s-page-header">
      <a-row class="k8s-header-content" :gutter="[24, 16]">
        <a-col :xs="24" :sm="24" :md="16" :lg="16" :xl="18">
          <div class="k8s-title-section">
            <div class="k8s-page-title">
              <PlayCircleOutlined class="k8s-title-icon" />
              <div>
                <h1>YAML ‰ªªÂä°ÁÆ°ÁêÜ</h1>
                <p class="k8s-page-subtitle">Âü∫‰∫éÊ®°ÊùøÂàõÂª∫ÂíåÊâßË°å Kubernetes YAML ÈÉ®ÁΩ≤‰ªªÂä°</p>
              </div>
            </div>
          </div>
        </a-col>
        <a-col :xs="24" :sm="24" :md="8" :lg="8" :xl="6">
          <div class="k8s-header-actions">
            <a-button type="primary" @click="openCreateModal" :disabled="!filterClusterId || !templates.length">
              <template #icon><PlusOutlined /></template>
              ÂàõÂª∫‰ªªÂä°
            </a-button>
            <a-button @click="fetchTasks" :loading="loading">
              <template #icon><ReloadOutlined /></template>
              Âà∑Êñ∞Êï∞ÊçÆ
            </a-button>
          </div>
        </a-col>
      </a-row>
    </div>

    <!-- Â∑•ÂÖ∑Ê†è -->
    <div class="k8s-toolbar">
      <!-- Á≠õÈÄâÂíåÊêúÁ¥¢Âå∫Âüü -->
      <div class="k8s-toolbar-filters">
        <div class="k8s-filter-group">
          <a-select 
            v-model:value="filterClusterId" 
            placeholder="ÈÄâÊã©ÈõÜÁæ§" 
            class="k8s-cluster-selector" 
            allow-clear 
            @change="handleClusterChange"
            :loading="clustersLoading"
            :disabled="clustersLoading"
            @popup-scroll="handleClusterDropdownScroll"
          >
            <template #suffixIcon><DatabaseOutlined /></template>
            <a-select-option v-for="cluster in clusters" :key="cluster.id" :value="cluster.id">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <span>{{ cluster.name }}</span>
                <a-tag color="blue" size="small">{{ getEnvText(cluster.env) }}</a-tag>
              </div>
            </a-select-option>
            <a-select-option 
              v-if="clusters.length > 0 && clusters.length < clustersTotal" 
              :value="'__load_more__'" 
              disabled
              style="text-align: center; color: #999;"
            >
              <a-spin size="small" :spinning="clustersLoading" />
              <span v-if="!clustersLoading">ÊªöÂä®Âä†ËΩΩÊõ¥Â§ö...</span>
            </a-select-option>
          </a-select>

          <a-select 
            v-model:value="filterTemplateId" 
            placeholder="ÈÄâÊã©Ê®°Êùø" 
            class="k8s-filter-select" 
            allow-clear 
            @change="handleFilterChange"
            :disabled="!filterClusterId"
            :loading="templatesLoading"
          >
            <template #suffixIcon><FileTextOutlined /></template>
            <a-select-option v-for="template in templates" :key="template.id" :value="template.id">
              {{ template.name }}
            </a-select-option>
            <a-select-option 
              v-if="templates.length > 0 && templates.length < templatesTotal" 
              :value="'__load_more_templates__'" 
              disabled
              style="text-align: center; color: #999;"
            >
              <a-button type="link" size="small" @click.stop="loadMoreTemplates" :loading="templatesLoading">
                Âä†ËΩΩÊõ¥Â§ö...
              </a-button>
            </a-select-option>
          </a-select>
          
          <a-select 
            v-model:value="filterStatus" 
            placeholder="Áä∂ÊÄÅÁ≠õÈÄâ" 
            class="k8s-filter-select" 
            allow-clear 
            @change="handleFilterChange"
          >
            <template #suffixIcon><FilterOutlined /></template>
            <a-select-option :value="TaskStatus.PENDING">‚è≥ Á≠âÂæÖ‰∏≠</a-select-option>
            <a-select-option :value="TaskStatus.RUNNING">‚ñ∂Ô∏è ËøêË°å‰∏≠</a-select-option>
            <a-select-option :value="TaskStatus.SUCCESS">‚úÖ ÊàêÂäü</a-select-option>
            <a-select-option :value="TaskStatus.FAILED">‚ùå Â§±Ë¥•</a-select-option>
            <a-select-option :value="TaskStatus.CANCELLED">‚è∏Ô∏è Â∑≤ÂèñÊ∂à</a-select-option>
          </a-select>
        </div>
        
        <div class="k8s-search-group">
          <a-input 
            v-model:value="searchText" 
            placeholder="üîç ÊêúÁ¥¢‰ªªÂä°ÂêçÁß∞" 
            class="k8s-search-input" 
            @pressEnter="onSearch"
            @input="onSearch"
            allow-clear 
          >
            <template #suffix>
              <SearchOutlined class="k8s-search-icon" />
            </template>
          </a-input>
        </div>
      </div>
      
      <!-- Êìç‰ΩúÂå∫Âüü -->
      <div class="k8s-toolbar-actions">
        <div class="k8s-action-buttons">
          <a-button 
            @click="resetFilters" 
            :disabled="!filterStatus && !searchText && !filterClusterId && !filterTemplateId"
            class="k8s-toolbar-btn"
            title="ÈáçÁΩÆÊâÄÊúâÁ≠õÈÄâÊù°‰ª∂"
          >
            <template #icon><DeleteOutlined /></template>
            ÈáçÁΩÆÁ≠õÈÄâ
          </a-button>
          
          <a-button 
            @click="fetchTasks" 
            :loading="loading"
            class="k8s-toolbar-btn"
            title="Âà∑Êñ∞Êï∞ÊçÆ"
          >
            <template #icon><ReloadOutlined /></template>
            Âà∑Êñ∞
          </a-button>
          
          <a-button 
            type="primary" 
            @click="() => batchOperation('ÊâßË°å')" 
            :disabled="!selectedRows.length || selectedRows.some(row => row.status === TaskStatus.RUNNING)" 
            v-if="selectedRows.length > 0"
            class="k8s-toolbar-btn"
            title="ÊâπÈáèÊâßË°åÈÄâ‰∏≠ÁöÑ‰ªªÂä°"
          >
            <template #icon><PlayCircleOutlined /></template>
            ÊâßË°å ({{ selectedRows.length }})
          </a-button>

          <a-button 
            type="primary" 
            danger 
            @click="() => batchOperation('Âà†Èô§')" 
            :disabled="!selectedRows.length" 
            v-if="selectedRows.length > 0"
            class="k8s-toolbar-btn"
            title="ÊâπÈáèÂà†Èô§ÈÄâ‰∏≠ÁöÑ‰ªªÂä°"
          >
            <template #icon><DeleteOutlined /></template>
            Âà†Èô§ ({{ selectedRows.length }})
          </a-button>
        </div>
      </div>
    </div>

    <!-- Êï∞ÊçÆÂ±ïÁ§∫Âå∫Âüü -->
    <div class="k8s-data-display">
      <a-table
        :columns="columns"
        :data-source="filteredTasks"
        :row-selection="rowSelection"
        :loading="loading"
        row-key="id"
        :pagination="{
          current: currentPage,
          pageSize: pageSize,
          total: total,
          showSizeChanger: true,
          showQuickJumper: true,
          showTotal: (total: number, range: number[]) => `ÊòæÁ§∫ ${range[0]}-${range[1]} Êù°ÔºåÂÖ± ${total} Êù°Êï∞ÊçÆ`,
          pageSizeOptions: ['10', '20', '30', '50']
        }"
        @change="handleTableChange"
        class="k8s-table task-table"
        :scroll="{ x: 1400 }"
      >
        <template #status="{ text }">
          <a-badge :status="getStatusColor(text)" :text="getStatusText(text)" />
        </template>

        <template #template_id="{ text }">
          <a-tag color="blue" v-if="text">{{ getTemplateName(text) }}</a-tag>
          <span v-else class="k8s-no-data">-</span>
        </template>

        <template #variables="{ text }">
          <div class="task-variables">
            <a-tag v-for="(variable, index) in (text || []).slice(0, 3)" :key="index" color="cyan" class="variable-tag">
              {{ variable }}
            </a-tag>
            <a-tooltip v-if="(text || []).length > 3" :title="(text || []).join('\n')">
              <a-tag color="cyan" class="variable-tag">
                +{{ (text || []).length - 3 }} Êõ¥Â§ö
              </a-tag>
            </a-tooltip>
            <span v-if="!text || !Array.isArray(text) || text.length === 0" class="k8s-no-data">-</span>
          </div>
        </template>

        <template #apply_result="{ text }">
          <div class="apply-result-preview">
            <code v-if="text" class="result-preview">{{ getResultPreview(text) }}</code>
            <span v-else class="k8s-no-data">-</span>
          </div>
        </template>

        <template #created_at="{ text }">
          <span class="task-time">{{ formatTime(text) }}</span>
        </template>

        <template #updated_at="{ text }">
          <span class="task-time">{{ formatTime(text) }}</span>
        </template>

        <template #actions="{ record }">
          <div class="k8s-action-column">
            <a-tooltip title="Êü•ÁúãËØ¶ÊÉÖ">
              <a-button title="Êü•ÁúãËØ¶ÊÉÖ" @click="showTaskDetail(record)">
                <template #icon><EyeOutlined /></template>
              </a-button>
            </a-tooltip>
            <a-tooltip title="ÊâßË°å‰ªªÂä°">
              <a-button 
                title="ÊâßË°å‰ªªÂä°" 
                @click="openExecuteModal(record)"
                :disabled="record.status === TaskStatus.RUNNING"
              >
                <template #icon><PlayCircleOutlined /></template>
              </a-button>
            </a-tooltip>
            <a-tooltip title="ÁºñËæë">
              <a-button 
                title="ÁºñËæë" 
                @click="openEditModal(record)"
                :disabled="record.status === TaskStatus.RUNNING"
              >
                <template #icon><EditOutlined /></template>
              </a-button>
            </a-tooltip>
            <a-tooltip title="Âà†Èô§">
              <a-button 
                title="Âà†Èô§" 
                danger 
                @click="deleteTask(record)"
                :disabled="record.status === TaskStatus.RUNNING"
              >
                <template #icon><DeleteOutlined /></template>
              </a-button>
            </a-tooltip>
          </div>
        </template>

        <template #emptyText>
          <div class="k8s-empty-state">
            <PlayCircleOutlined />
            <p>ÊöÇÊó†‰ªªÂä°Êï∞ÊçÆ</p>
            <p>ËØ∑ÂÖàÈÄâÊã©ÈõÜÁæ§ÂíåÊ®°Êùø</p>
          </div>
        </template>
      </a-table>
    </div>

    <!-- ÂàõÂª∫‰ªªÂä°Ê®°ÊÄÅÊ°Ü -->
    <a-modal
      v-model:open="isCreateModalVisible"
      title="ÂàõÂª∫ YAML ‰ªªÂä°"
      @ok="submitCreateForm"
      @cancel="closeCreateModal"
      :confirmLoading="submitLoading"
      width="700px"
      :maskClosable="false"
      destroyOnClose
      okText="ÂàõÂª∫"
      cancelText="ÂèñÊ∂à"
    >
      <a-form 
        ref="formRef"
        :model="createFormModel" 
        layout="vertical" 
        class="k8s-form"
        :rules="createFormRules"
      >
        <a-form-item label="‰ªªÂä°ÂêçÁß∞" name="name" :required="true">
          <a-input 
            v-model:value="createFormModel.name" 
            placeholder="ËØ∑ËæìÂÖ•‰ªªÂä°ÂêçÁß∞Ôºà‰æãÂ¶ÇÔºödeploy-nginx-prodÔºâ" 
            class="k8s-form-input"
            :maxlength="100"
          />
          <div style="color: #999; font-size: 12px; margin-top: 4px;">
            ÊîØÊåÅ‰∏≠Ëã±Êñá„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫øÂíåËøûÂ≠óÁ¨¶ÔºåÁî®‰∫éÊ†áËØÜÂíåÊü•Êâæ‰ªªÂä°
          </div>
        </a-form-item>

        <a-form-item label="ÈÄâÊã©Ê®°Êùø" name="template_id" :required="true">
          <a-select 
            v-model:value="createFormModel.template_id" 
            placeholder="ËØ∑ÈÄâÊã© YAML Ê®°Êùø" 
            class="k8s-form-input"
            :disabled="!filterClusterId"
            :loading="templatesLoading"
            @popup-scroll="handleTemplateDropdownScroll"
          >
            <a-select-option v-for="template in templates" :key="template.id" :value="template.id">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <span>{{ template.name }}</span>
                <a-tag color="green" size="small">ID: {{ template.id }}</a-tag>
              </div>
            </a-select-option>
            <a-select-option 
              v-if="templates.length > 0 && templates.length < templatesTotal" 
              :value="'__load_more_templates_create__'" 
              disabled
              style="text-align: center; color: #999;"
            >
              <a-button type="link" size="small" @click.stop="loadMoreTemplates" :loading="templatesLoading">
                Âä†ËΩΩÊõ¥Â§ö...
              </a-button>
            </a-select-option>
          </a-select>
        </a-form-item>

        <a-form-item label="‰ªªÂä°ÂèòÈáèÔºàÂèØÈÄâÔºâ">
          <div class="task-variables-config">
            <div v-if="createFormModel.variables.length === 0" style="text-align: center; color: #999; padding: 16px;">
              ÊöÇÊó†ÂèòÈáèÔºåÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∑ªÂä†
            </div>
            <div v-for="(_, index) in createFormModel.variables" :key="index" class="variable-input-row">
              <a-input 
                v-model:value="createFormModel.variables[index]" 
                placeholder="ËæìÂÖ•ÂèòÈáèÂÄºÔºà‰æãÂ¶ÇÔºönginx:1.20Ôºâ" 
                class="k8s-form-input"
                :maxlength="200"
              />
              <a-button 
                type="text" 
                danger 
                @click="removeVariableField(index)" 
                size="small"
              >
                <template #icon><DeleteOutlined /></template>
              </a-button>
            </div>
            <a-button type="dashed" @click="addVariableField" style="margin-top: 8px; width: 100%;">
              <template #icon><PlusOutlined /></template>
              Ê∑ªÂä†ÂèòÈáè
            </a-button>
          </div>
        </a-form-item>
      </a-form>
    </a-modal>

    <!-- ÁºñËæë‰ªªÂä°Ê®°ÊÄÅÊ°Ü -->
    <a-modal
      v-model:open="isEditModalVisible"
      title="ÁºñËæë YAML ‰ªªÂä°"
      @ok="submitEditForm"
      @cancel="closeEditModal"
      :confirmLoading="submitLoading"
      width="700px"
      :maskClosable="false"
      destroyOnClose
      okText="‰øùÂ≠ò"
      cancelText="ÂèñÊ∂à"
    >
      <a-form 
        ref="editFormRef"
        :model="editFormModel" 
        layout="vertical" 
        class="k8s-form"
        :rules="editFormRules"
      >
        <a-form-item label="‰ªªÂä°ÂêçÁß∞" name="name" :required="true">
          <a-input 
            v-model:value="editFormModel.name" 
            placeholder="ËØ∑ËæìÂÖ•‰ªªÂä°ÂêçÁß∞" 
            class="k8s-form-input"
            :maxlength="100"
          />
        </a-form-item>

        <a-form-item label="ÈÄâÊã©Ê®°Êùø">
          <a-select 
            v-model:value="editFormModel.template_id" 
            placeholder="ËØ∑ÈÄâÊã© YAML Ê®°Êùø" 
            class="k8s-form-input"
            :disabled="!filterClusterId"
            :loading="templatesLoading"
          >
            <a-select-option v-for="template in templates" :key="template.id" :value="template.id">
              <div style="display: flex; align-items: center; justify-content: space-between;">
                <span>{{ template.name }}</span>
                <a-tag color="green" size="small">ID: {{ template.id }}</a-tag>
              </div>
            </a-select-option>
          </a-select>
        </a-form-item>

        <a-form-item label="‰ªªÂä°ÂèòÈáè">
          <div class="task-variables-config">
            <div v-if="editFormModel.variables.length === 0" style="text-align: center; color: #999; padding: 16px;">
              ÊöÇÊó†ÂèòÈáèÔºåÁÇπÂáª‰∏ãÊñπÊåâÈíÆÊ∑ªÂä†
            </div>
            <div v-for="(_, index) in editFormModel.variables" :key="index" class="variable-input-row">
              <a-input 
                v-model:value="editFormModel.variables[index]" 
                placeholder="ËæìÂÖ•ÂèòÈáèÂÄº" 
                class="k8s-form-input"
                :maxlength="200"
              />
              <a-button 
                type="text" 
                danger 
                @click="removeEditVariableField(index)" 
                size="small"
              >
                <template #icon><DeleteOutlined /></template>
              </a-button>
            </div>
            <a-button type="dashed" @click="addEditVariableField" style="margin-top: 8px; width: 100%;">
              <template #icon><PlusOutlined /></template>
              Ê∑ªÂä†ÂèòÈáè
            </a-button>
          </div>
        </a-form-item>
      </a-form>
    </a-modal>

    <!-- ÊâßË°å‰ªªÂä°Ê®°ÊÄÅÊ°Ü -->
    <a-modal
      v-model:open="isExecuteModalVisible"
      title="ÊâßË°å‰ªªÂä°"
      @ok="submitExecuteForm"
      @cancel="closeExecuteModal"
      :confirmLoading="executeLoading"
      width="500px"
      :maskClosable="false"
      destroyOnClose
      okText="ÊâßË°å"
      cancelText="ÂèñÊ∂à"
    >
      <a-alert
        message="‰ªªÂä°ÊâßË°å"
        :description="`Âç≥Â∞ÜÊâßË°å‰ªªÂä° '${currentOperationTask?.name}'ÔºåËØ∑Á°ÆËÆ§ÊâßË°åÈÄâÈ°π`"
        type="info"
        show-icon
        style="margin-bottom: 24px;"
      />
      
      <a-form 
        ref="executeFormRef"
        :model="executeFormModel" 
        layout="vertical" 
        class="k8s-form"
      >
        <a-form-item label="ÊâßË°åÈÄâÈ°π">
          <a-checkbox v-model:checked="executeFormModel.dry_run">
            È¢ÑÊ£ÄÊü•Ê®°Âºè (Dry Run)
          </a-checkbox>
          <div style="color: #999; font-size: 12px; margin-top: 4px;">
            ÂãæÈÄâÂêéÂ∞Ü‰ªÖËøõË°åÈ¢ÑÊ£ÄÊü•Ôºå‰∏ç‰ºöÂÆûÈôÖÂ∫îÁî®Âà∞ÈõÜÁæ§
          </div>
        </a-form-item>

        <a-form-item label="‰ªªÂä°‰ø°ÊÅØ" v-if="currentOperationTask">
          <div class="task-info-display">
            <div class="info-item">
              <span class="info-label">‰ªªÂä°ÂêçÁß∞:</span>
              <span class="info-value">{{ currentOperationTask.name }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">‰ΩøÁî®Ê®°Êùø:</span>
              <span class="info-value">{{ getTemplateName(currentOperationTask.template_id) }}</span>
            </div>
            <div class="info-item" v-if="currentOperationTask.variables && currentOperationTask.variables.length > 0">
              <span class="info-label">ÂèòÈáèÂàóË°®:</span>
              <div class="info-variables">
                <a-tag v-for="(variable, index) in currentOperationTask.variables" :key="index" color="cyan">
                  {{ variable }}
                </a-tag>
              </div>
            </div>
          </div>
        </a-form-item>
      </a-form>
    </a-modal>

    <!-- ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
    <a-modal
      v-model:open="isDetailModalVisible"
      title="‰ªªÂä°ËØ¶ÊÉÖ"
      :footer="null"
      @cancel="closeDetailModal"
      width="900px"
      :maskClosable="false"
      destroyOnClose
    >
      <div v-if="currentTaskDetail" class="k8s-detail-content">
        <a-row :gutter="[24, 16]">
          <a-col :xs="24" :lg="12">
            <a-card title="Âü∫Êú¨‰ø°ÊÅØ" class="k8s-detail-card" size="small">
              <div class="k8s-detail-item">
                <span class="k8s-detail-label">‰ªªÂä°ID:</span>
                <span class="k8s-detail-value">{{ currentTaskDetail.id }}</span>
              </div>
              <div class="k8s-detail-item">
                <span class="k8s-detail-label">‰ªªÂä°ÂêçÁß∞:</span>
                <span class="k8s-detail-value">{{ currentTaskDetail.name }}</span>
              </div>
              <div class="k8s-detail-item">
                <span class="k8s-detail-label">Áä∂ÊÄÅ:</span>
                <a-badge :status="getStatusColor(currentTaskDetail.status)" :text="getStatusText(currentTaskDetail.status)" />
              </div>
              <div class="k8s-detail-item">
                <span class="k8s-detail-label">ÈõÜÁæ§ID:</span>
                <span class="k8s-detail-value">{{ currentTaskDetail.cluster_id }}</span>
              </div>
              <div class="k8s-detail-item">
                <span class="k8s-detail-label">Áî®Êà∑ID:</span>
                <span class="k8s-detail-value">{{ currentTaskDetail.user_id || '-' }}</span>
              </div>
            </a-card>
          </a-col>
          
          <a-col :xs="24" :lg="12">
            <a-card title="ÊâßË°å‰ø°ÊÅØ" class="k8s-detail-card" size="small">
              <div class="k8s-detail-item">
                <span class="k8s-detail-label">‰ΩøÁî®Ê®°Êùø:</span>
                <span class="k8s-detail-value">{{ getTemplateName(currentTaskDetail.template_id) }}</span>
              </div>
              <div class="k8s-detail-item">
                <span class="k8s-detail-label">ÂàõÂª∫Êó∂Èó¥:</span>
                <span class="k8s-detail-value">{{ formatTime(currentTaskDetail.created_at) }}</span>
              </div>
              <div class="k8s-detail-item">
                <span class="k8s-detail-label">Êõ¥Êñ∞Êó∂Èó¥:</span>
                <span class="k8s-detail-value">{{ formatTime(currentTaskDetail.updated_at) }}</span>
              </div>
            </a-card>
          </a-col>
        </a-row>

        <a-row :gutter="[24, 16]" style="margin-top: 16px;">
          <a-col :xs="24" :lg="12">
            <a-card title="‰ªªÂä°ÂèòÈáè" class="k8s-detail-card" size="small">
              <div class="task-variables">
                <a-tag v-for="(variable, index) in (currentTaskDetail.variables || [])" :key="index" color="cyan" style="margin-bottom: 8px;">
                  {{ variable }}
                </a-tag>
                <span v-if="!currentTaskDetail.variables || currentTaskDetail.variables.length === 0" class="k8s-no-data">
                  ÊöÇÊó†ÂèòÈáè
                </span>
              </div>
            </a-card>
          </a-col>

          <a-col :xs="24" :lg="12">
            <a-card title="ÊâßË°åÁªìÊûú" class="k8s-detail-card" size="small">
              <pre v-if="currentTaskDetail.apply_result" class="apply-result-detail">{{ currentTaskDetail.apply_result }}</pre>
              <span v-else class="k8s-no-data">ÊöÇÊó†ÊâßË°åÁªìÊûú</span>
            </a-card>
          </a-col>
        </a-row>
      </div>
    </a-modal>

  </div>
</template>

<script lang="ts" setup>
import { onMounted } from 'vue';
import { message } from 'ant-design-vue';
import { useTaskPage } from './Task';
import { 
  PlusOutlined, 
  ReloadOutlined, 
  FilterOutlined, 
  DeleteOutlined, 
  PlayCircleOutlined,
  EyeOutlined,
  SearchOutlined,
  EditOutlined,
  FileTextOutlined,
  DatabaseOutlined,
} from '@ant-design/icons-vue';

const {
  // state
  tasks,
  templates,
  clusters,
  loading,
  clustersLoading,
  templatesLoading,
  searchText,
  filterClusterId,
  filterTemplateId,
  filterStatus,
  selectedRows,
  currentPage,
  pageSize,
  total,
  clustersTotal,
  templatesTotal,
  
  // modal state
  isCreateModalVisible,
  isEditModalVisible,
  isDetailModalVisible,
  isExecuteModalVisible,
  submitLoading,
  executeLoading,
  
  // operation targets
  currentOperationTask,
  currentTaskDetail,
  
  // form models
  createFormModel,
  editFormModel,
  executeFormModel,
  
  // form refs
  formRef,
  editFormRef,
  
  // form rules
  createFormRules,
  editFormRules,
  
  // computed
  filteredTasks,
  rowSelection,
  
  // helpers
  getEnvText,
  getStatusText,
  getStatusColor,
  formatTime,
  getTemplateName,
  
  // operations
  fetchClusters,
  fetchTemplates,
  fetchTasks,
  clearTasks,
  clearTemplates,
  loadMoreClusters,
  loadMoreTemplates,
  
  // detail operations
  showTaskDetail,
  closeDetailModal,
  
  // create operations
  openCreateModal,
  closeCreateModal,
  submitCreateForm,
  
  // edit operations
  openEditModal,
  closeEditModal,
  submitEditForm,
  
  // execute operations
  openExecuteModal,
  closeExecuteModal,
  submitExecuteForm,
  
  // task operations
  deleteTask,
  
  // batch operations
  batchOperation,
  
  // pagination operations
  handlePageChange,
  
  // form field operations
  addVariableField,
  removeVariableField,
  addEditVariableField,
  removeEditVariableField,
  
  // constants
  TaskStatus,
} = useTaskPage();

const onSearch = () => {
  currentPage.value = 1;
  fetchTasks();
};

const handleFilterChange = () => {
  currentPage.value = 1;
  fetchTasks();
};

const handleClusterChange = () => {
  currentPage.value = 1;
  clearTemplates();
  clearTasks();
  
  if (filterClusterId.value) {
    const selectedCluster = clusters.value.find(c => c.id === filterClusterId.value);
    if (selectedCluster) {
      message.info(`Â∑≤ÂàáÊç¢Âà∞ÈõÜÁæ§: ${selectedCluster.name}`);
    }
    fetchTemplates(true); // ÈáçÁΩÆÊ®°ÊùøÂàÜÈ°µ
    fetchTasks();
  } else {
    message.info('Â∑≤Ê∏ÖÁ©∫‰ªªÂä°ÂàóË°®ÔºåËØ∑ÈÄâÊã©ÈõÜÁæ§Êü•Áúã‰ªªÂä°');
  }
};

const handleTableChange = (pagination: { current?: number; pageSize?: number }) => {
  if (pagination) {
    handlePageChange(pagination.current || currentPage.value, pagination.pageSize);
  }
};

// Â§ÑÁêÜÈõÜÁæ§‰∏ãÊãâÈÄâÊã©ÁöÑÊªöÂä®‰∫ã‰ª∂
const handleClusterDropdownScroll = (e: Event) => {
  const { target } = e;
  if (target && 'scrollTop' in target && 'scrollHeight' in target && 'clientHeight' in target) {
    const scrollTarget = target as HTMLElement;
    if (scrollTarget.scrollTop + scrollTarget.clientHeight >= scrollTarget.scrollHeight - 5) {
      loadMoreClusters();
    }
  }
};

// Â§ÑÁêÜÊ®°Êùø‰∏ãÊãâÈÄâÊã©ÁöÑÊªöÂä®‰∫ã‰ª∂
const handleTemplateDropdownScroll = (e: Event) => {
  const { target } = e;
  if (target && 'scrollTop' in target && 'scrollHeight' in target && 'clientHeight' in target) {
    const scrollTarget = target as HTMLElement;
    if (scrollTarget.scrollTop + scrollTarget.clientHeight >= scrollTarget.scrollHeight - 5) {
      loadMoreTemplates();
    }
  }
};

// Ëé∑ÂèñÊâßË°åÁªìÊûúÈ¢ÑËßàÂÜÖÂÆπ
const getResultPreview = (result: string) => {
  if (!result) return 'ÊöÇÊó†ÁªìÊûú';
  const lines = result.split('\n');
  if (lines.length <= 2) return result;
  return lines.slice(0, 2).join('\n') + '\n...';
};

const columns = [
  { title: 'ID', dataIndex: 'id', key: 'id', width: '5%' },
  { title: 'ÂêçÁß∞', dataIndex: 'name', key: 'name', width: '13%' },
  { title: 'Áä∂ÊÄÅ', dataIndex: 'status', key: 'status', width: '9%', slots: { customRender: 'status' } },
  { title: '‰ΩøÁî®Ê®°Êùø', dataIndex: 'template_id', key: 'template_id', width: '11%', slots: { customRender: 'template_id' } },
  { title: 'ÂèòÈáè', dataIndex: 'variables', key: 'variables', width: '13%', slots: { customRender: 'variables' } },
  { title: 'ÊâßË°åÁªìÊûú', dataIndex: 'apply_result', key: 'apply_result', width: '18%', slots: { customRender: 'apply_result' } },
  { title: 'ÂàõÂª∫Êó∂Èó¥', dataIndex: 'created_at', key: 'created_at', width: '9%', slots: { customRender: 'created_at' } },
  { title: 'Êõ¥Êñ∞Êó∂Èó¥', dataIndex: 'updated_at', key: 'updated_at', width: '9%', slots: { customRender: 'updated_at' } },
  { title: 'Êìç‰Ωú', key: 'actions', width: '13%', fixed: 'right', slots: { customRender: 'actions' } },
];

// ÈáçÁΩÆÊâÄÊúâÁ≠õÈÄâÊù°‰ª∂
const resetFilters = () => {
  filterStatus.value = undefined;
  filterTemplateId.value = undefined;
  searchText.value = '';
  filterClusterId.value = undefined;
  currentPage.value = 1;
  clearTasks();
  clearTemplates();
  message.success('Â∑≤ÈáçÁΩÆÊâÄÊúâÁ≠õÈÄâÊù°‰ª∂');
};

onMounted(async () => {
  await fetchClusters();
});
</script>

<style scoped>
@import '../shared/k8s-common.css';
</style>

<style scoped src="./Task.css"></style>
